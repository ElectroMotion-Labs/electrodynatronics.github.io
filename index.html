<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <h1 id="honda-haru-motor-module-control-program-c-and-python-external-version">HONDA HARU Motor Module Control Program C++ and Python (External Version)</h1> <ul> <li><a href="#introduction">Introduction</a></li> <li><a href="#test-machine-details">Test Machine Details</a></li> <li><a href="#initial-steps">Initial Steps</a></li> <li> <a href="#running-the-programs">Running the Programs</a> <ul> <li><a href="#basic-setup">Basic Setup</a></li> <li><a href="#testing-the-motors">Testing the motors</a></li> <li><a href="#runing-the-joystick-program">Runing the Joystick Program</a></li> </ul> </li> <li><a href="#structure-of-the-main-program">Structure of the Main Program</a></li> <li><a href="#providing-custom-inputs-without-the-gamepad">Providing Custom Inputs Without the Gamepad</a></li> <li><a href="#time-profiling-of-the-program-with-the-current-hardware-and-software">Time Profiling of the Program With the Current Hardware and Software</a></li> </ul> <h2 id="introduction">Introduction</h2> <p>This program has been developed to control the KTH neck module of the Honda HARU. The details of the test machine and on running the program are given below.</p> <h2 id="test-machine-details">Test Machine Details</h2> <ol> <li> <strong>Processor</strong>: Intel Core i5-4300 CPU @ 1.90 GHz (2.50 GHz Peak)</li> <li> <strong>RAM</strong>: DDR3 16.0 GB</li> <li> <strong>Disk space</strong>: 80.12 GB</li> <li> <strong>OS</strong>: Ubuntu 22.04 full (normal) installation</li> <li> <strong>C++ version</strong>: 11.3.0</li> <li> <strong>Python version</strong>: 3.10.6</li> </ol> <h2 id="initial-steps">Initial Steps</h2> <ol> <li>Run the following code <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> sudo apt-get update
 sudo apt-get upgrade
</code></pre></div> </div> </li> <li>Download and install Dynamixel Wizard following instructions given on the Robotis website <a href="https://emanual.robotis.com/docs/en/software/dynamixel/dynamixel_wizard2/#install-linux" rel="external nofollow noopener" target="_blank">(installations and download link)</a> </li> <li>Download the Dynamixel SDK from the Robotis website <a href="https://github.com/ROBOTIS-GIT/DynamixelSDK/archive/refs/heads/master.zip" rel="external nofollow noopener" target="_blank">(download link)</a> </li> <li>Unzip the downloaded Dynamixel SDK into a folder of your choice</li> <li>Follow the installation instructions for the Dynamixel SDK corresponding to C++ Linux <a href="https://emanual.robotis.com/docs/en/software/dynamixel/dynamixel_sdk/library_setup/cpp_linux/#cpp-linux" rel="external nofollow noopener" target="_blank">(installation instructions)</a> </li> <li>IMPORTANT!! Before running the test program disconnect the motor from any mechanical assemblies!!! (the motor with ID 1 needs to be free to rotate for the default example)</li> <li>Additionally, change the buadrate and dynamixel ID in the <code class="language-plaintext highlighter-rouge">.cpp</code> file before running the test program. You might also have to also edit the control table addresses depending on the motor</li> <li>If you would like to use an Xbox 360 controller, follow the instructions given on this page, <a href="https://askubuntu.com/questions/14849/how-to-use-xbox-360-wireless-gaming-controller" rel="external nofollow noopener" target="_blank">link</a> </li> <li> <ol> <li>To, check if the Xbox controller works, run <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> sudo apt-get update
 sudo apt-get install jstest-gtk
</code></pre></div> </div> </li> </ol> </li> <li>Install the latest version of Python 3</li> <li>Install the setserial module, by running <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>sudo apt-get install setserial
</code></pre></div> </div> </li> <li>Install Gnome Terminal to run multiple parallel instances of terminal <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>sudo apt-get install gnome-terminal
</code></pre></div> </div> </li> </ol> <h2 id="running-the-programs">Running the Programs</h2> <h3 id="basic-setup">Basic Setup</h3> <ol> <li>Download this program as a .zip file and extract it into a folder of your choice</li> <li>Ensure that the IDs of your motors are set according to the figure given below and change the baud rate for the motors to 4000000 (4M) on Dynamixel Wizard <img src="Images/motor_ids.jpg" alt=""> </li> </ol> <h3 id="testing-the-motors">Testing the motors</h3> <ol> <li>Ensure that the motor IDs and baud rates match the figure above</li> <li>Ensure that the port is correctly set in this file (#define DEVICENAME)</li> <li>Disconenct the motors from all loads (wire ropes included)</li> <li>Set all motors to a set poisition of 0 on the dynamixel wizard</li> <li>Check if all motors are rotating synchronously</li> <li>To terminate, hit Ctrl+C on terminal</li> </ol> <h3 id="runing-the-joystick-program">Runing the Joystick Program</h3> <ol> <li>Connect an Xbox 360 controller</li> <li>Run <code class="language-plaintext highlighter-rouge">jstest-gtk</code> from the menu and test the controller</li> <li>Note: The following programs work only on AMD64 architecture and a 64bit OS and assumes that the motors and U2D2 are connected on <code class="language-plaintext highlighter-rouge">/dev/ttyUSB0</code> </li> <li>Navigate to program folder of your choice, for example <code class="language-plaintext highlighter-rouge">[KTH HARU C++ Directory]/Programs/HARU Program Sync Read Write</code> </li> <li>Open terminal in this folder</li> <li>Run the bash script to run the test program <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> ./run_haru_sync_read_write.sh
</code></pre></div> </div> </li> <li>The script will spawn a new terminal window and request the root password</li> <li>The robot can now be controlled using the right joystick of the gamepad</li> <li>Incase of any errors, disconnect and reconnect the gamepad and all connected USB devices</li> <li>Repeat the instructions from the start</li> </ol> <h2 id="structure-of-the-main-program">Structure of the Main Program</h2> <ol> <li>The program consists of 3 parts, the wrapper bash script, the C++ program to communicate with the motors, and the Python program to read from the gamepad</li> <li>The bash script provides a wrapper to concurrently execute the phython and C++ programs</li> <li>A short overview of the bash script <ul> <li>The bash script executes the Python program on a seperate termial instance with root previlages</li> <li>Next, the script sets the latency timer of <code class="language-plaintext highlighter-rouge">/dev/ttyUSB0</code> to 1ms (this is the minimum value)</li> <li>The bash sript then compiles the C++ program and runs it on the current terminal instance</li> </ul> </li> <li>The Python program communicates with the C++ program through a memory mapped file</li> </ol> <h2 id="providing-custom-inputs-without-the-gamepad">Providing Custom Inputs Without the Gamepad</h2> <ol> <li>In order to provide custom inputs to the program without using a gamepad, the memory mapped file has to be updated by a feedeer program</li> <li>The memory mapped file is a binary file named <code class="language-plaintext highlighter-rouge">data_exchange_file.bin</code> and contains two IEEE 754 float values expressed as binary values</li> <li>The first float value refers to roll movement of the robot expressed in the range [-1, +1], the second float value refers to the pitch movement expressed in the range [-1, +1]</li> <li>In order to provide inputs to this memory mapped file, you will need to create a program that accesses the memory mapped file with write previlages</li> </ol> <h2 id="time-profiling-of-the-program-with-the-current-hardware-and-software">Time Profiling of the Program With the Current Hardware and Software</h2> <ol> <li>Note: The program works as intended only whe the USB latency is set to 1ms. The default is 16ms, and this slows the communication to a large extent.</li> <li>To check if the USB latency, run, <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> cat /sys/bus/usb-serial/devices/ttyUSB0/latency_timer
</code></pre></div> </div> </li> <li>HARU Program With Classic Read Write (1 write and 1 read each for 4 motors): best case execution time approximately 10ms</li> <li>HARU Program With Sync Read Write (1 write and 5 reads each for 4 motors): best case execution time approximately 6ms</li> <li>The times are approximate and can sometimes take longer if the OS doesnâ€™t allocate processor time accordingly</li> </ol> </body></html>